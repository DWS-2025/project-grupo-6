<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/product-cards.css">
    <link rel="stylesheet" href="/css/wellcome.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/price-filter.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
</head>

<body class="bg-[#F5EFEB] font-['Inter']">
    {{> common/header}}

    <main class="p-6 max-w-7xl mx-auto">
        {{#errorMessage}}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
            <span class="block sm:inline font-light">{{errorMessage}}</span>
        </div>
        {{/errorMessage}}

        <div class="flex justify-between items-center mb-8 border-b border-[#294156]/10 pb-4">
            <h2 class="text-2xl font-light tracking-wide text-[#294156] relative inline-block after:content-[''] after:absolute after:-bottom-1 after:left-0 after:w-1/3 after:h-0.5 after:bg-[#294156]/30">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                Available Products
            </h2>
        </div>
        
        <!-- Search Box and Sort Options -->
        <div class="mb-6 flex flex-wrap gap-2">
            <input type="text" id="productSearch" placeholder="Search products by name..." 
                   class="w-full md:flex-1 p-3 border border-[#294156]/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#294156]/50" />
            <button id="searchButton" class="button px-6 py-3 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                Search
            </button>
            <select id="priceSort" class="p-3 border border-[#294156]/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#294156]/50 bg-white">
                <option value="default">Sort by</option>
                <option value="price_asc">Price: Low to High</option>
                <option value="price_desc">Price: High to Low</option>
            </select>
        </div>

        <!-- Price Range Filter -->
        <div class="mb-6 bg-white p-4 rounded-lg shadow-sm border border-[#294156]/10">
            <h3 class="text-[#294156] font-medium mb-3">Filter by Price</h3>
            
            <!-- Price Range Slider -->
            <div class="relative mb-4 h-10">
                <div class="slider-track h-2 bg-gray-200 rounded absolute w-full top-1/2 transform -translate-y-1/2"></div>
                <div class="range-selected absolute top-1/2 transform -translate-y-1/2 h-2 bg-[#294156] rounded"></div>
                
                <input type="range" id="price-range-min" min="0" max="1000" value="0" step="1"
                       class="price-range-input absolute top-0 left-0 w-full h-10 opacity-0 cursor-pointer z-10" />
                <input type="range" id="price-range-max" min="0" max="1000" value="1000" step="1"
                       class="price-range-input absolute top-0 left-0 w-full h-10 opacity-0 cursor-pointer z-20" />
                
                <div class="range-min-thumb absolute top-1/2 transform -translate-y-1/2 -translate-x-1/2 w-5 h-5 bg-[#294156] rounded-full cursor-pointer z-30"></div>
                <div class="range-max-thumb absolute top-1/2 transform -translate-y-1/2 -translate-x-1/2 w-5 h-5 bg-[#294156] rounded-full cursor-pointer z-30"></div>
            </div>
            
            <!-- Price Range Display -->
            <div class="flex justify-between text-xs text-[#294156]/70 mb-2">
                <span id="range-min-display">$0</span>
                <span id="range-midpoint-display">$500</span>
                <span id="range-max-display">$1000</span>
            </div>
            
            <!-- Price Range Inputs -->
            <div class="flex items-center gap-4 mb-2">
                <div class="flex-1">
                    <label for="price-min" class="block text-sm text-[#294156]/70 mb-1">Min Price ($)</label>
                    <input type="number" id="price-min" min="0" max="1000" value="0" 
                           class="w-full p-2 border border-[#294156]/20 rounded focus:outline-none focus:ring-1 focus:ring-[#294156]" />
                </div>
                <div class="flex-1">
                    <label for="price-max" class="block text-sm text-[#294156]/70 mb-1">Max Price ($)</label>
                    <input type="number" id="price-max" min="0" max="1000" value="1000" 
                           class="w-full p-2 border border-[#294156]/20 rounded focus:outline-none focus:ring-1 focus:ring-[#294156]" />
                </div>
            </div>
            
            <!-- Apply Filter Button -->
            <div class="flex gap-2">
                <button id="apply-price-filter" class="flex-1 bg-[#294156] text-white px-4 py-2 rounded hover:bg-[#567C8D] transition-colors">
                    Apply Filter
                </button>
                <button id="reset-price-filter" class="px-4 py-2 rounded border border-[#294156] text-[#294156] hover:bg-[#294156]/10 transition-colors">
                    Reset
                </button>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6" id="productsGrid">
            <!-- Los productos se cargarán dinámicamente mediante JavaScript -->
        </div>

        <div class="text-center mt-8 mb-6">
            <button id="loadMoreBtn" class="button px-6 py-3 rounded-lg bg-[#294156] text-white hover:bg-[#567C8D] transition-all duration-300 flex items-center mx-auto shadow-md hover:shadow-lg transform hover:-translate-y-1" onclick="loadMoreProducts()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
                Load More Products
            </button>
        </div>
    </main>

    {{> common/footer}}
</body>
</html>

<script>
    let currentProductPage = 1;
    const productsPerPage = 5;
    let allProductsLoaded = false;
    let minPrice = 0;
    let maxPrice = 1000;
    let dynamicMaxPrice = 1000; // This will be updated from server
    let currentSortValue = "default";

    // Fetch the initial max price for filter setup
    async function fetchInitialMaxPrice() {
        try {
            const response = await fetch(`/api/products?page=1&size=1`);
            const data = await response.json();
            
            if (data.maxPriceForFilter) {
                dynamicMaxPrice = Math.ceil(data.maxPriceForFilter);
                maxPrice = dynamicMaxPrice;
                
                // También buscar el precio mínimo de los productos
                fetch(`/api/products?page=1&size=${productsPerPage}&sort=price_asc`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.products && data.products.length > 0) {
                            // Obtener el precio mínimo encontrado
                            const lowestPrice = Math.floor(data.products[0].price);
                            
                            // Actualizar el precio mínimo si es mayor que cero
                            if (lowestPrice > 0) {
                                minPrice = lowestPrice;
                                // También actualizar el input del slider
                                const minRangeInput = document.getElementById('price-range-min');
                                const minValueInput = document.getElementById('price-min');
                                
                                minRangeInput.min = minPrice;
                                minValueInput.min = minPrice;
                                minRangeInput.value = minPrice;
                                minValueInput.value = minPrice;
                                
                                // Actualizar el texto del label
                                document.querySelector('label[for="price-min"]').textContent = `Min Price ($${minPrice})`;
                            }
                        }
                        
                        // Update range inputs with the new max price
                        const maxRangeInput = document.getElementById('price-range-max');
                        const maxValueInput = document.getElementById('price-max');
                        const minRangeInput = document.getElementById('price-range-min');
                        
                        maxRangeInput.max = dynamicMaxPrice;
                        maxValueInput.max = dynamicMaxPrice;
                        maxRangeInput.value = dynamicMaxPrice;
                        maxValueInput.value = dynamicMaxPrice;
                        
                        // Ajustar el step del slider basado en el rango
                        const priceDifference = dynamicMaxPrice - minPrice;
                        let stepSize = 1;
                        
                        if (priceDifference < 20) {
                            stepSize = 0.5;
                        } else if (priceDifference < 100) {
                            stepSize = 1;
                        } else if (priceDifference < 1000) {
                            stepSize = 5;
                        } else {
                            stepSize = 10;
                        }
                        
                        minRangeInput.step = stepSize;
                        maxRangeInput.step = stepSize;
                        
                        console.log(`Updated price range: ${minPrice} - ${dynamicMaxPrice}, step: ${stepSize}`);
                        
                        // Setup slider after getting min/max prices
                        setupPriceSlider();
                    })
                    .catch(error => {
                        console.error("Error fetching min price:", error);
                        setupPriceSlider();
                    });
            }
        } catch (error) {
            console.error("Error fetching max price:", error);
            // Still set up the slider with default values if there's an error
            setupPriceSlider();
        }
    }
    
    // Call this on page load
    window.onload = function() {
        fetchInitialMaxPrice().then(() => {
            loadMoreProducts();
        });
    };

    // Setup price range sliders
    function setupPriceSlider() {
        const minRangeInput = document.getElementById('price-range-min');
        const maxRangeInput = document.getElementById('price-range-max');
        const minValueInput = document.getElementById('price-min');
        const maxValueInput = document.getElementById('price-max');
        const rangeMinThumb = document.querySelector('.range-min-thumb');
        const rangeMaxThumb = document.querySelector('.range-max-thumb');
        const rangeSelected = document.querySelector('.range-selected');
        const sliderTrack = document.querySelector('.slider-track');
        const applyFilterBtn = document.getElementById('apply-price-filter');
        
        // Update label text to show the dynamic max price
        document.querySelector('label[for="price-max"]').textContent = `Max Price ($${dynamicMaxPrice})`;
        
        // Set initial positions of thumbs
        function setThumbPosition(thumb, input) {
            const percent = (parseInt(input.value) / parseInt(input.max)) * 100;
            thumb.style.left = `${percent}%`;
        }
        
        // Set initial positions
        setThumbPosition(rangeMinThumb, minRangeInput);
        setThumbPosition(rangeMaxThumb, maxRangeInput);
        updateRangeVisuals();
        
        // Handle track clicks to set thumb positions
        sliderTrack.addEventListener('click', function(e) {
            // Calculate click position as percentage
            const trackRect = sliderTrack.getBoundingClientRect();
            const clickPosition = e.clientX - trackRect.left;
            const percentPosition = (clickPosition / trackRect.width) * 100;
            const clickValue = Math.round((percentPosition / 100) * parseInt(maxRangeInput.max));
            
            // Determine which thumb to move (closest one)
            const minThumbPos = parseInt(minRangeInput.value);
            const maxThumbPos = parseInt(maxRangeInput.value);
            
            if (Math.abs(clickValue - minThumbPos) <= Math.abs(clickValue - maxThumbPos)) {
                // Move min thumb
                minRangeInput.value = clickValue;
                minValueInput.value = clickValue;
                setThumbPosition(rangeMinThumb, minRangeInput);
            } else {
                // Move max thumb
                maxRangeInput.value = clickValue;
                maxValueInput.value = clickValue;
                setThumbPosition(rangeMaxThumb, maxRangeInput);
            }
            
            updateRangeVisuals();
        });
        
        // Handle min range input changes
        minRangeInput.addEventListener('input', function() {
            let minVal = parseInt(minRangeInput.value);
            let maxVal = parseInt(maxRangeInput.value);
            
            // Ensure min doesn't exceed max - 10
            if (minVal > maxVal - 10) {
                minVal = maxVal - 10;
                minRangeInput.value = minVal;
            }
            
            minValueInput.value = minVal;
            setThumbPosition(rangeMinThumb, minRangeInput);
            updateRangeVisuals();
        });
        
        // Handle max range input changes
        maxRangeInput.addEventListener('input', function() {
            let minVal = parseInt(minRangeInput.value);
            let maxVal = parseInt(maxRangeInput.value);
            
            // Ensure max doesn't go below min + 10
            if (maxVal < minVal + 10) {
                maxVal = minVal + 10;
                maxRangeInput.value = maxVal;
            }
            
            maxValueInput.value = maxVal;
            setThumbPosition(rangeMaxThumb, maxRangeInput);
            updateRangeVisuals();
        });
        
        // Handle min input field changes
        minValueInput.addEventListener('change', function() {
            let minVal = parseInt(minValueInput.value);
            let maxVal = parseInt(maxValueInput.value);
            
            // Validate input
            if (isNaN(minVal) || minVal < 0) minVal = 0;
            if (minVal > maxVal - 10) minVal = maxVal - 10;
            
            minValueInput.value = minVal;
            minRangeInput.value = minVal;
            setThumbPosition(rangeMinThumb, minRangeInput);
            updateRangeVisuals();
        });
        
        // Handle max input field changes
        maxValueInput.addEventListener('change', function() {
            let minVal = parseInt(minValueInput.value);
            let maxVal = parseInt(maxValueInput.value);
            
            // Validate input
            if (isNaN(maxVal) || maxVal > dynamicMaxPrice) maxVal = dynamicMaxPrice;
            if (maxVal < minVal + 10) maxVal = minVal + 10;
            
            maxValueInput.value = maxVal;
            maxRangeInput.value = maxVal;
            setThumbPosition(rangeMaxThumb, maxRangeInput);
            updateRangeVisuals();
        });
        
        // Update visual elements of the range slider
        function updateRangeVisuals() {
            const minVal = parseInt(minRangeInput.value);
            const maxVal = parseInt(maxRangeInput.value);
            const minPercent = (minVal / parseInt(minRangeInput.max)) * 100;
            const maxPercent = (maxVal / parseInt(maxRangeInput.max)) * 100;
            
            rangeSelected.style.left = `${minPercent}%`;
            rangeSelected.style.width = `${maxPercent - minPercent}%`;
            
            // Actualizar textos de visualización de rango
            document.getElementById('range-min-display').textContent = `$${minVal}`;
            document.getElementById('range-max-display').textContent = `$${maxVal}`;
            
            // Calcular y mostrar el punto medio
            const midpointValue = Math.round((minVal + maxVal) / 2);
            document.getElementById('range-midpoint-display').textContent = `$${midpointValue}`;
        }
        
        // Apply filter button click handler
        applyFilterBtn.addEventListener('click', function() {
            minPrice = parseInt(minValueInput.value);
            maxPrice = parseInt(maxValueInput.value);
            
            // Reset page counter and reload products with filter
            currentProductPage = 1;
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '';
            loadMoreProducts();
        });
        
        // Setup price sort dropdown
        const priceSort = document.getElementById('priceSort');
        priceSort.addEventListener('change', function() {
            currentSortValue = this.value;
            
            // Optionally, we can reset the price filter when changing sort
            if (this.value === 'default') {
                // Reset price filter to default values
                minValueInput.value = 0;
                maxValueInput.value = dynamicMaxPrice;
                minRangeInput.value = 0;
                maxRangeInput.value = dynamicMaxPrice;
                minPrice = 0;
                maxPrice = dynamicMaxPrice;
                
                // Update range slider visuals
                setThumbPosition(rangeMinThumb, minRangeInput);
                setThumbPosition(rangeMaxThumb, maxRangeInput);
                updateRangeVisuals();
            }
            
            // Reset and reload with current filter and sort
            currentProductPage = 1;
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '';
            loadMoreProducts();
        });
        
        // Add event listener for reset button
        document.getElementById('reset-price-filter').addEventListener('click', function(e) {
            e.preventDefault();
            resetPriceFilter();
        });
    }

    // Function to reset the price filter
    function resetPriceFilter() {
        const minRangeInput = document.getElementById('price-range-min');
        const maxRangeInput = document.getElementById('price-range-max');
        const minValueInput = document.getElementById('price-min');
        const maxValueInput = document.getElementById('price-max');
        const rangeMinThumb = document.querySelector('.range-min-thumb');
        const rangeMaxThumb = document.querySelector('.range-max-thumb');
        
        minValueInput.value = minPrice; // Usar el precio mínimo encontrado en lugar de 0
        maxValueInput.value = dynamicMaxPrice;
        minRangeInput.value = minPrice; // Usar el precio mínimo encontrado en lugar de 0
        maxRangeInput.value = dynamicMaxPrice;
        
        // Update range slider visuals
        const rangeSelected = document.querySelector('.range-selected');
        const minPercent = 0;
        const maxPercent = 100;
        
        rangeMinThumb.style.left = `${minPercent}%`;
        rangeMaxThumb.style.left = `${maxPercent}%`;
        rangeSelected.style.left = `${minPercent}%`;
        rangeSelected.style.width = `${maxPercent - minPercent}%`;
        
        // Reset page counter and reload products
        currentProductPage = 1;
        const productsGrid = document.getElementById('productsGrid');
        productsGrid.innerHTML = '';
        loadMoreProducts();
    }
    
    function loadMoreProducts() {
        // Disable the button while loading products
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = 'Loading...';
        
        // Make AJAX request to the server to get the next page of products
        fetch(`/api/products?page=${currentProductPage}&size=${productsPerPage}&minPrice=${minPrice}&maxPrice=${maxPrice}&sort=${currentSortValue}`)
            .then(response => response.json())
            .then(data => {
                const products = data.products;
                const productsGrid = document.getElementById('productsGrid');
                
                console.log('Products received:', products);
                
                if (products && products.length > 0) {
                    // Add each product to the grid
                    products.forEach(product => {
                        console.log('Processing product:', product);
                        const template = `
                            <div class="product-card rounded-lg overflow-hidden product-item" data-id="${product.id}" data-name="${product.name}" data-price="${product.price}">
                                <div class="product-image-container">
                                    <a href="/product-details?id=${product.id}">
                                        <img src="/image/${product.id}" alt="${product.name}" class="cursor-pointer hover:scale-105 transition-transform duration-500">
                                    </a>
                                </div>
                                <div class="product-info p-3 space-y-1">
                                    <h3 class="product-name text-[#294156] text-lg font-medium leading-snug">${product.name}</h3>
                                    <p class="text-[#567C8D] font-light">$${product.price}</p>
                                    <p class="text-[#567C8D]/70 text-sm font-light">Stock: ${product.stock}</p>
                                </div>
                                <div class="product-buttons space-y-2 p-4 pt-0">
                                    <form action="/add-to-order" method="post" class="block add-to-cart-form">
                                        <input type="hidden" name="productId" value="${product.id}">
                                        <button type="submit" class="w-full bg-[#294156] text-white px-4 py-2 rounded hover:bg-[green] transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                            </svg>
                                            Add to Cart
                                        </button>
                                    </form>
                                    ${product.isAdmin ? `
                                    <form action="/delete-product" method="post" class="block">
                                        <input type="hidden" name="productId" value="${product.id}">
                                        <button type="submit" class="w-full bg-[#567C8D] text-white px-4 py-2 rounded hover:bg-[red] transition-colors">Delete Product</button>
                                    </form>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                        
                        // Add the product to the grid
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = template.trim();
                        productsGrid.appendChild(tempDiv.firstChild);
                    });
                    
                    // Attach event listeners to the newly added forms
                    attachAddToCartListeners(document.querySelectorAll('.add-to-cart-form'));
                    
                    // Increment the page counter
                    currentProductPage++;
                    
                    // Enable the button again
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = 'Load More Products';
                    
                    // Check if there are more products to load
                    if (!data.hasMore || products.length < productsPerPage) {
                        loadMoreBtn.style.display = 'none';
                        allProductsLoaded = true;
                    } else {
                        loadMoreBtn.style.display = '';
                    }
                } else {
                    // No products found with current filters
                    if (currentProductPage === 1) {
                        productsGrid.innerHTML = `
                            <div class="col-span-full text-center py-8">
                                <p class="text-[#294156] opacity-70">No products found within the selected price range.</p>
                                <button id="reset-filters" class="mt-4 bg-[#567C8D] text-white px-4 py-2 rounded hover:bg-[#294156] transition-colors">
                                    Reset Filters
                                </button>
                            </div>
                        `;
                        
                        // Add event listener to reset filters button
                        document.getElementById('reset-filters').addEventListener('click', function() {
                            // Reset price filter
                            resetPriceFilter();
                        });
                    }
                    
                    // Hide load more button
                    loadMoreBtn.style.display = 'none';
                    allProductsLoaded = true;
                }
            })
            .catch(error => {
                console.error('Error loading products:', error);
                const productsGrid = document.getElementById('productsGrid');
                if (currentProductPage === 1) {
                    productsGrid.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <p class="text-red-500">Error loading products. Please try again.</p>
                        </div>
                    `;
                }
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = 'Load More Products';
            });
    }

    // Function to attach event listeners to add-to-cart forms
    function attachAddToCartListeners(forms) {
        forms.forEach(form => {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const button = this.querySelector('button');
                const originalText = button.innerHTML;
                const originalColor = button.style.backgroundColor;
                const stock = this.closest('.product-card').querySelector('.product-info p:nth-child(3)').textContent;
                const stockNumber = parseInt(stock.replace('Stock: ', ''), 10);

                if (stockNumber <= 0) {
                    button.textContent = 'Out of Stock!';
                    button.style.backgroundColor = 'red';
                    button.disabled = true;

                    // Restore button after 1 second
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.backgroundColor = originalColor;
                        button.disabled = false;
                    }, 1000); // 1000 ms = 1 second

                    return; // Stop code execution
                }

                button.disabled = true;
                
                try {
                    // Check the quantity in the cart
                    const productId = this.querySelector('input[name="productId"]').value;
                    const cartResponse = await fetch(`/get-cart-quantity?productId=${productId}`);
                    const cartData = await cartResponse.json();
                    const cartQuantity = cartData.quantity || 0;
                    
                    // Check if adding one more exceeds the stock
                    if (cartQuantity + 1 > stockNumber) {
                        button.textContent = 'Out of Stock!';
                        button.style.backgroundColor = 'red';
                        
                        // Restore button after 1 second
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.style.backgroundColor = originalColor;
                            button.disabled = false;
                        }, 1000); // 1000 ms = 1 second
                        
                        return;
                    }
                    
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: new FormData(this)
                    });
                    
                    // Try to process the response as JSON, but don't fail if it's not JSON
                    let data = {};
                    try {
                        data = await response.json();
                    } catch (e) {
                        console.log('Response is not JSON, continuing...');
                    }
                    
                    if (response.ok) {
                        button.textContent = 'Added!';
                        button.style.backgroundColor = 'green';
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.style.backgroundColor = originalColor;
                            button.disabled = false;
                        }, 1000);
                        
                        // Update the cart counter in the header
                        const cartCounter = document.querySelector('.cart-counter');
                        if (cartCounter && data && data.cartSize) {
                            cartCounter.textContent = data.cartSize;
                        }
                    } else {
                        throw new Error('Failed to add to cart');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    button.textContent = 'Error';
                    button.style.backgroundColor = 'red';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.backgroundColor = originalColor;
                        button.disabled = false;
                    }, 2000);
                }
            });
        });
    }

    // Existing cart functionality - now using the function
    document.addEventListener('DOMContentLoaded', function() {
        // Product search functionality
        const searchInput = document.getElementById('productSearch');
        const searchButton = document.getElementById('searchButton');
        const productCards = document.querySelectorAll('.product-card');
        const priceSort = document.getElementById('priceSort');

        // Price sorting functionality
        priceSort.addEventListener('change', function() {
            const sortValue = this.value;
            
            // Clear the products grid
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '<div class="col-span-full text-center py-8">Loading products...</div>';
            
            // Reset pagination
            currentProductPage = 1;
            
            // Load sorted products
            fetch(`/api/products?page=1&size=${productsPerPage}&sort=${sortValue}`)
                .then(response => response.json())
                .then(data => {
                    // Clear the grid
                    productsGrid.innerHTML = '';
                    
                    if (data.products && data.products.length > 0) {
                        // Show the products
                        data.products.forEach(product => {
                            const template = `
                                <div class="product-card rounded-lg overflow-hidden product-item" data-id="${product.id}" data-name="${product.name}" data-price="${product.price}">
                                    <div class="product-image-container">
                                        <a href="/product-details?id=${product.id}">
                                            <img src="/image/${product.id}" alt="${product.name}" class="cursor-pointer hover:scale-105 transition-transform duration-500">
                                        </a>
                                    </div>
                                    <div class="product-info p-3 space-y-1">
                                        <h3 class="product-name text-[#294156] text-lg font-medium leading-snug">${product.name}</h3>
                                        <p class="text-[#567C8D] font-light">$${product.price}</p>
                                        <p class="text-[#567C8D]/70 text-sm font-light">Stock: ${product.stock}</p>
                                    </div>
                                    <div class="product-buttons space-y-2 p-4 pt-0">
                                        <form action="/add-to-order" method="post" class="block add-to-cart-form">
                                            <input type="hidden" name="productId" value="${product.id}">
                                            <button type="submit" class="w-full bg-[#294156] text-white px-4 py-2 rounded hover:bg-[green] transition-colors">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                                </svg>
                                                Add to Cart
                                            </button>
                                        </form>
                                        ${product.isAdmin ? `
                                        <form action="/delete-product" method="post" class="block">
                                            <input type="hidden" name="productId" value="${product.id}">
                                            <button type="submit" class="w-full bg-[#567C8D] text-white px-4 py-2 rounded hover:bg-[red] transition-colors">Delete Product</button>
                                        </form>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                            
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = template.trim();
                            productsGrid.appendChild(tempDiv.firstChild);
                        });
                        
                        // Attach event listeners
                        attachAddToCartListeners(document.querySelectorAll('.add-to-cart-form'));
                        
                        // Increment page
                        currentProductPage++;
                        
                        // Update "Load More" button
                        const loadMoreBtn = document.getElementById('loadMoreBtn');
                        if (data.hasMore) {
                            loadMoreBtn.style.display = '';
                            loadMoreBtn.disabled = false;
                            
                            // Modify onclick to include sorting
                            loadMoreBtn.onclick = function() {
                                loadMoreProductsWithSort(sortValue);
                            };
                        } else {
                            loadMoreBtn.style.display = 'none';
                        }
                    } else {
                        // No products available
                        productsGrid.innerHTML = `
                            <div class="col-span-full text-center py-8">
                                <p>No products available</p>
                            </div>
                        `;
                        document.getElementById('loadMoreBtn').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading sorted products:', error);
                    productsGrid.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <p>Error loading products. Please try again.</p>
                        </div>
                    `;
                    document.getElementById('loadMoreBtn').style.display = 'none';
                });
        });
        
        // Database search
        searchButton.addEventListener('click', async function() {
            const searchTerm = searchInput.value.trim();
            performSearch(searchTerm);
        });
        
        // También permitir búsqueda al presionar Enter
        searchInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const searchTerm = this.value.trim();
                performSearch(searchTerm);
            }
        });
        
        // Función compartida para realizar la búsqueda
        async function performSearch(searchTerm) {
            // If search term is empty, load all products
            if (!searchTerm) {
                window.location.href = '/products';
                return;
            }
            
            try {
                // Clear the products grid
                const productsGrid = document.getElementById('productsGrid');
                productsGrid.innerHTML = '';
                
                // Reset pagination
                currentProductPage = 1;
                
                // Show loading message
                productsGrid.innerHTML = '<div class="col-span-full text-center py-8">Loading results...</div>';
                
                // Get current price filter values
                const currentMinPrice = parseInt(document.getElementById('price-min').value) || 0;
                const currentMaxPrice = parseInt(document.getElementById('price-max').value) || dynamicMaxPrice;
                
                // Make search request with price filters
                const response = await fetch(`/search-products-json?term=${encodeURIComponent(searchTerm)}&page=1&size=${productsPerPage}&minPrice=${currentMinPrice}&maxPrice=${currentMaxPrice}`);
            
                if (response.ok) {
                    const data = await response.json();
                    
                    // Clear the grid
                    productsGrid.innerHTML = '';
                    
                    if (data.products && data.products.length > 0) {
                        // Show found products
                        data.products.forEach(product => {
                            const template = `
                                <div class="product-card rounded-lg overflow-hidden product-item" data-id="${product.id}" data-name="${product.name}" data-price="${product.price}">
                                    <div class="product-image-container">
                                        <a href="/product-details?id=${product.id}">
                                            <img src="/image/${product.id}" alt="${product.name}" class="cursor-pointer hover:scale-105 transition-transform duration-500">
                                        </a>
                                    </div>
                                    <div class="product-info p-3 space-y-1">
                                        <h3 class="product-name text-[#294156] text-lg font-medium leading-snug">${product.name}</h3>
                                        <p class="text-[#567C8D] font-light">$${product.price}</p>
                                        <p class="text-[#567C8D]/70 text-sm font-light">Stock: ${product.stock}</p>
                                    </div>
                                    <div class="product-buttons space-y-2 p-4 pt-0">
                                        <form action="/add-to-order" method="post" class="block add-to-cart-form">
                                            <input type="hidden" name="productId" value="${product.id}">
                                            <button type="submit" class="w-full bg-[#294156] text-white px-4 py-2 rounded hover:bg-[green] transition-colors">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                                </svg>
                                                Add to Cart
                                            </button>
                                        </form>
                                        ${product.isAdmin ? `
                                        <form action="/delete-product" method="post" class="block">
                                            <input type="hidden" name="productId" value="${product.id}">
                                            <button type="submit" class="w-full bg-[#567C8D] text-white px-4 py-2 rounded hover:bg-[red] transition-colors">Delete Product</button>
                                        </form>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                            
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = template.trim();
                            productsGrid.appendChild(tempDiv.firstChild);
                        });
                        
                        // Attach event listeners
                        attachAddToCartListeners(document.querySelectorAll('.add-to-cart-form'));
                        
                        // Increment page
                        currentProductPage++;
                        
                        // Update "Load More" button
                        const loadMoreBtn = document.getElementById('loadMoreBtn');
                        if (data.hasMore) {
                            loadMoreBtn.style.display = '';
                            loadMoreBtn.disabled = false;
                            // Change onclick function to use search term
                            loadMoreBtn.onclick = function() {
                                loadMoreSearchResults(searchTerm);
                            };
                        } else {
                            loadMoreBtn.style.display = 'none';
                        }
                    } else {
                        // No products found
                        productsGrid.innerHTML = `
                            <div class="col-span-full text-center py-8">
                                <p>No products found for "${searchTerm}"</p>
                            </div>
                        `;
                        document.getElementById('loadMoreBtn').style.display = 'none';
                    }
                } else {
                    throw new Error('Search failed');
                }
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('productsGrid').innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <p>Error searching for products. Please try again.</p>
                    </div>
                `;
                document.getElementById('loadMoreBtn').style.display = 'none';
            }
        }
        
        // Function to load more search results
        function loadMoreSearchResults(searchTerm) {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = 'Loading...';
            
            // Get current price filter values
            const currentMinPrice = parseInt(document.getElementById('price-min').value) || 0;
            const currentMaxPrice = parseInt(document.getElementById('price-max').value) || dynamicMaxPrice;
            
            fetch(`/search-products-json?term=${encodeURIComponent(searchTerm)}&page=${currentProductPage}&size=${productsPerPage}&minPrice=${currentMinPrice}&maxPrice=${currentMaxPrice}`)
                .then(response => response.json())
                .then(data => {
                    const products = data.products;
                    const productsGrid = document.getElementById('productsGrid');
                    
                    if (products && products.length > 0) {
                        // Add products to the grid
                        products.forEach(product => {
                            const template = `
                                <div class="product-card rounded-lg overflow-hidden product-item" data-id="${product.id}" data-name="${product.name}" data-price="${product.price}">
                                    <div class="product-image-container">
                                        <a href="/product-details?id=${product.id}">
                                            <img src="/image/${product.id}" alt="${product.name}" class="cursor-pointer hover:scale-105 transition-transform duration-500">
                                        </a>
                                    </div>
                                    <div class="product-info p-3 space-y-1">
                                        <h3 class="product-name text-[#294156] text-lg font-medium leading-snug">${product.name}</h3>
                                        <p class="text-[#567C8D] font-light">$${product.price}</p>
                                        <p class="text-[#567C8D]/70 text-sm font-light">Stock: ${product.stock}</p>
                                    </div>
                                    <div class="product-buttons space-y-2 p-4 pt-0">
                                        <form action="/add-to-order" method="post" class="block add-to-cart-form">
                                            <input type="hidden" name="productId" value="${product.id}">
                                            <button type="submit" class="w-full bg-[#294156] text-white px-4 py-2 rounded hover:bg-[green] transition-colors">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                                </svg>
                                                Add to Cart
                                            </button>
                                        </form>
                                        ${product.isAdmin ? `
                                        <form action="/delete-product" method="post" class="block">
                                            <input type="hidden" name="productId" value="${product.id}">
                                            <button type="submit" class="w-full bg-[#567C8D] text-white px-4 py-2 rounded hover:bg-[red] transition-colors">Delete Product</button>
                                        </form>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                            
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = template.trim();
                            productsGrid.appendChild(tempDiv.firstChild);
                        });
                        
                        // Attach event listeners
                        attachAddToCartListeners(document.querySelectorAll('.add-to-cart-form'));
                        
                        // Increment page
                        currentProductPage++;
                        
                        // Update button state
                        loadMoreBtn.disabled = false;
                        loadMoreBtn.textContent = 'Load More Products';
                        
                        if (!data.hasMore) {
                            loadMoreBtn.style.display = 'none';
                        }
                    } else {
                        // No more products
                        loadMoreBtn.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading more search results:', error);
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = 'Load More Products';
                });
        }
        
        // Function to load more products with specific sorting
        function loadMoreProductsWithSort(sortValue) {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = 'Loading...';
            
            fetch(`/api/products?page=${currentProductPage}&size=${productsPerPage}&sort=${sortValue}`)
                .then(response => response.json())
                .then(data => {
                    const products = data.products;
                    const productsGrid = document.getElementById('productsGrid');
                    
                    if (products && products.length > 0) {
                        // Add products to the grid
                        products.forEach(product => {
                            const template = `
                                <div class="product-card rounded-lg overflow-hidden product-item" data-id="${product.id}" data-name="${product.name}" data-price="${product.price}">
                                    <div class="product-image-container">
                                        <a href="/product-details?id=${product.id}">
                                            <img src="/image/${product.id}" alt="${product.name}" class="cursor-pointer hover:scale-105 transition-transform duration-500">
                                        </a>
                                    </div>
                                    <div class="product-info p-3 space-y-1">
                                        <h3 class="product-name text-[#294156] text-lg font-medium leading-snug">${product.name}</h3>
                                        <p class="text-[#567C8D] font-light">$${product.price}</p>
                                        <p class="text-[#567C8D]/70 text-sm font-light">Stock: ${product.stock}</p>
                                    </div>
                                    <div class="product-buttons space-y-2 p-4 pt-0">
                                        <form action="/add-to-order" method="post" class="block add-to-cart-form">
                                            <input type="hidden" name="productId" value="${product.id}">
                                            <button type="submit" class="w-full bg-[#294156] text-white px-4 py-2 rounded hover:bg-[green] transition-colors">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                                </svg>
                                                Add to Cart
                                            </button>
                                        </form>
                                        ${product.isAdmin ? `
                                        <form action="/delete-product" method="post" class="block">
                                            <input type="hidden" name="productId" value="${product.id}">
                                            <button type="submit" class="w-full bg-[#567C8D] text-white px-4 py-2 rounded hover:bg-[red] transition-colors">Delete Product</button>
                                        </form>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                            
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = template.trim();
                            productsGrid.appendChild(tempDiv.firstChild);
                        });
                        
                        // Attach event listeners
        attachAddToCartListeners(document.querySelectorAll('.add-to-cart-form'));
                        
                        // Increment page
                        currentProductPage++;
                        
                        // Update button state
                        loadMoreBtn.disabled = false;
                        loadMoreBtn.textContent = 'Load More Products';
                        
                        if (!data.hasMore) {
                            loadMoreBtn.style.display = 'none';
                        }
                    } else {
                        // No more products
                        loadMoreBtn.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading more sorted products:', error);
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = 'Load More Products';
                });
        }
    });
</script>